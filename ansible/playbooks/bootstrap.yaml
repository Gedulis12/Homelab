---
- name: Cluster Bootstraping
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - vars/sealed-secret-key.yaml
  tasks:
    - name: Create sealed-secrets namespace
      kubernetes.core.k8s:
        name: sealed-secrets
        api_version: v1
        kind: Namespace
        state: present

    - name: Apply manifest for sealed-secret key
      kubernetes.core.k8s:
        state: present
        definition: "{{ manifest }}"

      # https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api/#prerequisites
    - name: Install Gateway API CRDs
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
      loop:
        - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gatewayclasses.yaml
        - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_gateways.yaml
        - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_httproutes.yaml
        - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_referencegrants.yaml
        - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/standard/gateway.networking.k8s.io_grpcroutes.yaml
        - https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml

    - name: Add metrics scrape annotation for CoreDNS
      kubernetes.core.k8s:
        state: patched
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: kube-dns
            namespace: kube-system
            annotations:
              'k8s.grafana.com/scrape': 'true'
